# å¾®ä¿¡å…¬ä¼—å·é…ç½®æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•é…ç½®å¾®ä¿¡å…¬ä¼—å·ï¼Œè·å–AppIDã€AppSecretå’Œæ¨¡æ¿IDï¼Œä»¥ä¾¿ä¸æ¯æ—¥ä¿¡æ¯ç®€æŠ¥ç³»ç»Ÿé›†æˆã€‚

## 1. å‡†å¤‡å·¥ä½œ

### 1.1 å¾®ä¿¡å…¬ä¼—å·ç±»å‹é€‰æ‹©

å¾®ä¿¡å…¬ä¼—å·åˆ†ä¸ºå‡ ç§ç±»å‹ï¼Œæ¨èé€‰æ‹©ï¼š

- **æœåŠ¡å·**ï¼šåŠŸèƒ½æœ€å…¨ï¼Œæ”¯æŒæ¨¡æ¿æ¶ˆæ¯æ¨é€ï¼ˆæ¨èï¼‰
- **è®¢é˜…å·**ï¼šåŠŸèƒ½å—é™ï¼Œéƒ¨åˆ†é«˜çº§åŠŸèƒ½ä¸å¯ç”¨

### 1.2 æ³¨å†Œå¾®ä¿¡å…¬ä¼—å·

1. è®¿é—® [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. ç‚¹å‡»"ç«‹å³æ³¨å†Œ"
3. é€‰æ‹©"æœåŠ¡å·"æˆ–"è®¢é˜…å·"
4. æŒ‰ç…§æµç¨‹å®Œæˆæ³¨å†Œå’Œè®¤è¯

## 2. è·å– AppID å’Œ AppSecret

### 2.1 ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°

1. ä½¿ç”¨æ³¨å†Œçš„è´¦å·ç™»å½• [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. è¿›å…¥"å¼€å‘" -> "åŸºæœ¬é…ç½®"

### 2.2 è·å– AppID å’Œ AppSecret

åœ¨"åŸºæœ¬é…ç½®"é¡µé¢ï¼š

1. **AppID(åº”ç”¨ID)**ï¼šç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œç›´æ¥å¤åˆ¶å³å¯
2. **AppSecret(åº”ç”¨å¯†é’¥)**ï¼š
   - ç‚¹å‡»"é‡ç½®"æŒ‰é’®
   - æŒ‰ç…§æç¤ºæ“ä½œè·å–æ–°çš„AppSecret
   - **é‡è¦**ï¼šAppSecretåªæ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·ç«‹å³ä¿å­˜

![åŸºæœ¬é…ç½®é¡µé¢](https://res.wx.qq.com/op_res/9r1k8097X8XaVqRqLZ0L7L4L4L4L4L4L)

### 2.3 é…ç½®IPç™½åå•ï¼ˆå¯é€‰ä½†æ¨èï¼‰

åœ¨"åŸºæœ¬é…ç½®"é¡µé¢åº•éƒ¨ï¼š

1. ç‚¹å‡»"é…ç½®"IPç™½åå•
2. æ·»åŠ æœåŠ¡å™¨IPåœ°å€
3. å¦‚æœä¸é…ç½®ï¼Œæ‰€æœ‰IPéƒ½å¯ä»¥è°ƒç”¨æ¥å£ï¼ˆå®‰å…¨æ€§è¾ƒä½ï¼‰

## 3. å¯ç”¨æœåŠ¡å™¨é…ç½®

### 3.1 å¼€å¯å¼€å‘è€…æ¨¡å¼

åœ¨"å¼€å‘" -> "åŸºæœ¬é…ç½®"é¡µé¢ï¼š

1. å°†"å¼€å‘è€…å¯†ç (AppSecret)"å³ä¾§çš„å¼€å…³æ‰“å¼€
2. å¯ç”¨æœåŠ¡å™¨é…ç½®

### 3.2 æœåŠ¡å™¨é…ç½®ï¼ˆå¦‚æœä½¿ç”¨webhookï¼‰

å¦‚æœéœ€è¦å¾®ä¿¡æœåŠ¡å™¨å›è°ƒä½ çš„æœåŠ¡å™¨ï¼š

1. **URL**ï¼šå¡«å†™ä½ çš„æœåŠ¡å™¨åœ°å€ï¼Œå¦‚ `https://yourdomain.com/wechat`
2. **Token**ï¼šè‡ªå®šä¹‰ä¸€ä¸ªä»¤ç‰Œï¼Œç”¨äºéªŒè¯
3. **EncodingAESKey**ï¼šé€‰æ‹©"å®‰å…¨æ¨¡å¼"æ—¶ä½¿ç”¨
4. **æ¶ˆæ¯åŠ è§£å¯†æ–¹å¼**ï¼šé€‰æ‹©"å…¼å®¹æ¨¡å¼"æˆ–"å®‰å…¨æ¨¡å¼"

## 4. åˆ›å»ºæ¨¡æ¿æ¶ˆæ¯

### 4.1 è¿›å…¥æ¨¡æ¿æ¶ˆæ¯ç®¡ç†

1. ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°
2. è¿›å…¥"åŠŸèƒ½" -> "æ¨¡æ¿æ¶ˆæ¯"
3. ç‚¹å‡»"æ¨¡æ¿åº“"

### 4.2 é€‰æ‹©è¡Œä¸šæ¨¡æ¿

1. é€‰æ‹©ä¸¤ä¸ªä¸»è¦è¡Œä¸šï¼ˆä¼šå½±å“å¯ç”¨çš„æ¨¡æ¿ï¼‰
2. æ¨èé€‰æ‹©ï¼š
   - ITç§‘æŠ€ - äº’è”ç½‘|ç”µå­å•†åŠ¡
   - ç”Ÿæ´»æœåŠ¡ - é¤é¥®

### 4.3 æ·»åŠ æ¨¡æ¿

åœ¨æ¨¡æ¿åº“ä¸­æœç´¢ä»¥ä¸‹å…³é”®è¯ï¼š

- **å¤©æ°”æé†’**
- **ç”Ÿæ´»æœåŠ¡æé†’**
- **æ—¥å¸¸æé†’**
- **é€šçŸ¥æé†’**

é€‰æ‹©é€‚åˆçš„æ¨¡æ¿ï¼Œç‚¹å‡»"è¯¦æƒ…"æŸ¥çœ‹æ¨¡æ¿å†…å®¹æ ¼å¼ã€‚

### 4.4 è·å–æ¨¡æ¿ID

æ·»åŠ æ¨¡æ¿åï¼š

1. åœ¨"æˆ‘çš„æ¨¡æ¿"é¡µé¢æ‰¾åˆ°åˆšæ·»åŠ çš„æ¨¡æ¿
2. å¤åˆ¶"æ¨¡æ¿ID"
3. è®°å½•æ¨¡æ¿å†…å®¹æ ¼å¼ï¼Œç”¨äºåç»­ç¼–ç¨‹

## 5. é…ç½®åˆ°æ¯æ—¥ä¿¡æ¯ç®€æŠ¥ç³»ç»Ÿ

### 5.1 åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶

```bash
cp .env.example .env
```

### 5.2 ç¼–è¾‘ .env æ–‡ä»¶

```env
# å¾®ä¿¡å…¬ä¼—å·é…ç½®
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_APP_SECRET=abcdef1234567890abcdef1234567890
WECHAT_TEMPLATE_ID=AbcDefGhIjKlMnOpQrStUvWxYz123456

# å¤©æ°”APIé…ç½®ï¼ˆå¯é€‰ï¼‰
WEATHER_API_KEY=your_weather_api_key

# æ—¥å¿—çº§åˆ«
LOG_LEVEL=INFO
```

### 5.3 é…ç½®è¯´æ˜

- **WECHAT_APP_ID**ï¼šæ›¿æ¢ä¸ºä½ çš„AppID
- **WECHAT_APP_SECRET**ï¼šæ›¿æ¢ä¸ºä½ çš„AppSecret
- **WECHAT_TEMPLATE_ID**ï¼šæ›¿æ¢ä¸ºä½ çš„æ¨¡æ¿ID

## 6. æ¨¡æ¿æ¶ˆæ¯æ ¼å¼é…ç½®

### 6.1 æ¨¡æ¿æ¶ˆæ¯ç»“æ„

å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯æ ¼å¼ç¤ºä¾‹ï¼š

```json
{
    "touser": "OPENID",
    "template_id": "TEMPLATE_ID", 
    "url": "https://example.com",
    "data": {
        "first": {
            "value": "æ ‡é¢˜",
            "color": "#173177"
        },
        "keyword1": {
            "value": "å†…å®¹1",
            "color": "#173177"
        },
        "keyword2": {
            "value": "å†…å®¹2", 
            "color": "#173177"
        },
        "remark": {
            "value": "å¤‡æ³¨",
            "color": "#173177"
        }
    }
}
```

### 6.2 é€‚é…ç³»ç»Ÿæ¶ˆæ¯æ ¼å¼

åœ¨ `daily_briefing.py` ä¸­ï¼Œéœ€è¦æ ¹æ®æ¨¡æ¿æ ¼å¼è°ƒæ•´æ¶ˆæ¯ç»“æ„ï¼š

```python
def format_wechat_template_message(self, message: str) -> dict:
    """æ ¼å¼åŒ–å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯"""
    return {
        "touser": "ç”¨æˆ·OPENID",  # éœ€è¦è·å–ç”¨æˆ·å…³æ³¨å…¬ä¼—å·çš„OPENID
        "template_id": self.wechat_config["template_id"],
        "url": "https://example.com",  # å¯é€‰ï¼Œç‚¹å‡»è·³è½¬é“¾æ¥
        "data": {
            "first": {
                "value": "ğŸŒ… æ—©å®‰ï¼ä»Šæ—¥ä¿¡æ¯ç®€æŠ¥",
                "color": "#173177"
            },
            "keyword1": {
                "value": "åŒ—äº¬åœ°åŒº",
                "color": "#173177"
            },
            "keyword2": {
                "value": datetime.now().strftime("%Y-%m-%d %H:%M"),
                "color": "#173177"
            },
            "remark": {
                "value": "ğŸ’¡ æ¸©é¦¨æç¤ºï¼šæ³¨æ„å¤©æ°”å˜åŒ–ï¼Œåˆç†å®‰æ’å‡ºè¡Œï¼",
                "color": "#173177"
            }
        }
    }
```

## 7. è·å–ç”¨æˆ·OPENID

### 7.1 ç”¨æˆ·å…³æ³¨å…¬ä¼—å·

ç”¨æˆ·éœ€è¦å…ˆå…³æ³¨ä½ çš„å…¬ä¼—å·ï¼Œæ‰èƒ½æ¥æ”¶æ¨¡æ¿æ¶ˆæ¯ã€‚

### 7.2 è·å–ç”¨æˆ·åˆ—è¡¨

é€šè¿‡å¾®ä¿¡æ¥å£è·å–å…³æ³¨ç”¨æˆ·åˆ—è¡¨ï¼š

```python
def get_user_list(self, access_token: str) -> list:
    """è·å–å…¬ä¼—å·å…³æ³¨ç”¨æˆ·åˆ—è¡¨"""
    url = f"https://api.weixin.qq.com/cgi-bin/user/get?access_token={access_token}"
    response = requests.get(url)
    if response.status_code == 200:
        data = response.json()
        return data.get("data", {}).get("openid", [])
    return []
```

## 8. å®Œæ•´çš„å¾®ä¿¡APIé›†æˆ

### 8.1 è·å–Access Token

```python
def get_access_token(self) -> str:
    """è·å–å¾®ä¿¡Access Token"""
    url = f"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid={self.wechat_config['app_id']}&secret={self.wechat_config['app_secret']}"
    response = requests.get(url)
    if response.status_code == 200:
        data = response.json()
        return data.get("access_token", "")
    return ""
```

### 8.2 å‘é€æ¨¡æ¿æ¶ˆæ¯

```python
def send_template_message(self, access_token: str, template_data: dict) -> bool:
    """å‘é€æ¨¡æ¿æ¶ˆæ¯"""
    url = f"https://api.weixin.qq.com/cgi-bin/message/template/send?access_token={access_token}"
    response = requests.post(url, json=template_data)
    if response.status_code == 200:
        result = response.json()
        return result.get("errcode", -1) == 0
    return False
```

## 9. æµ‹è¯•é…ç½®

### 9.1 æµ‹è¯•Access Tokenè·å–

```python
# æµ‹è¯•ä»£ç 
token = get_access_token()
if token:
    print("Access Tokenè·å–æˆåŠŸ")
else:
    print("Access Tokenè·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥AppIDå’ŒAppSecret")
```

### 9.2 æµ‹è¯•æ¨¡æ¿æ¶ˆæ¯å‘é€

```python
# æµ‹è¯•å‘é€ç»™æŒ‡å®šç”¨æˆ·
user_openid = "ç”¨æˆ·çš„OPENID"  # æ›¿æ¢ä¸ºå®é™…ç”¨æˆ·OPENID
template_msg = format_wechat_template_message("æµ‹è¯•æ¶ˆæ¯")
template_msg["touser"] = user_openid

success = send_template_message(token, template_msg)
if success:
    print("æ¨¡æ¿æ¶ˆæ¯å‘é€æˆåŠŸ")
else:
    print("æ¨¡æ¿æ¶ˆæ¯å‘é€å¤±è´¥")
```

## 10. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 10.1 AppSecreté”™è¯¯

**é—®é¢˜**ï¼š`{"errcode":40001,"errmsg":"invalid credential"}`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥AppSecretæ˜¯å¦æ­£ç¡®
- ç¡®è®¤IPç™½åå•é…ç½®
- é‡æ–°è·å–AppSecret

### 10.2 æ¨¡æ¿IDé”™è¯¯

**é—®é¢˜**ï¼š`{"errcode":40037,"errmsg":"invalid template_id"}`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æ¨¡æ¿IDæ˜¯å¦æ­£ç¡®
- ç¡®è®¤æ¨¡æ¿æ˜¯å¦å·²æ·»åŠ å¹¶å¯ç”¨

### 10.3 ç”¨æˆ·æœªå…³æ³¨

**é—®é¢˜**ï¼š`{"errcode":40003,"errmsg":"invalid openid"}`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®è®¤ç”¨æˆ·å·²å…³æ³¨å…¬ä¼—å·
- æ£€æŸ¥OPENIDæ˜¯å¦æ­£ç¡®

### 10.4 é¢‘ç‡é™åˆ¶

**é—®é¢˜**ï¼š`{"errcode":45015,"errmsg":"response out of time limit"}`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å¾®ä¿¡å¯¹æ¨¡æ¿æ¶ˆæ¯å‘é€é¢‘ç‡æœ‰é™åˆ¶
- é¿å…çŸ­æ—¶é—´å†…å‘é€å¤§é‡æ¶ˆæ¯

## 11. å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ä¿æŠ¤AppSecret**ï¼šä¸è¦å°†AppSecretæäº¤åˆ°ä»£ç ä»“åº“
2. **ä½¿ç”¨ç¯å¢ƒå˜é‡**ï¼šé€šè¿‡.envæ–‡ä»¶ç®¡ç†æ•æ„Ÿä¿¡æ¯
3. **IPç™½åå•**ï¼šé…ç½®æœåŠ¡å™¨IPç™½åå•å¢å¼ºå®‰å…¨æ€§
4. **å®šæœŸæ›´æ¢**ï¼šå®šæœŸæ›´æ¢AppSecret
5. **ç›‘æ§æ—¥å¿—**ï¼šç›‘æ§APIè°ƒç”¨æ—¥å¿—ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸

## 12. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### 12.1 æœåŠ¡å™¨è¦æ±‚

- æ”¯æŒHTTPSï¼ˆå¾®ä¿¡APIè¦æ±‚ï¼‰
- å›ºå®šIPåœ°å€ï¼ˆç”¨äºIPç™½åå•ï¼‰
- Python 3.7+ ç¯å¢ƒ

### 12.2 éƒ¨ç½²æ­¥éª¤

1. å°†ä»£ç éƒ¨ç½²åˆ°æœåŠ¡å™¨
2. é…ç½®ç¯å¢ƒå˜é‡
3. è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆcrontabï¼‰
4. ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€

## 13. åç»­ç»´æŠ¤

### 13.1 å®šæœŸæ£€æŸ¥

- æ¯æœˆæ£€æŸ¥Access Tokenè·å–æ˜¯å¦æ­£å¸¸
- å®šæœŸæµ‹è¯•æ¨¡æ¿æ¶ˆæ¯å‘é€
- ç›‘æ§ç”¨æˆ·åé¦ˆ

### 13.2 åŠŸèƒ½æ‰©å±•

- æ·»åŠ æ›´å¤šæ•°æ®æº
- æ”¯æŒå¤šåœ°åŒºå¤©æ°”
- é›†æˆæ›´å¤šç”Ÿæ´»æœåŠ¡ä¿¡æ¯

---

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæ‚¨å°±å¯ä»¥æˆåŠŸé…ç½®å¾®ä¿¡å…¬ä¼—å·ï¼Œå®ç°æ¯æ—¥ä¿¡æ¯ç®€æŠ¥çš„è‡ªåŠ¨æ¨é€åŠŸèƒ½ã€‚å¦‚æœåœ¨é…ç½®è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒå¸¸è§é—®é¢˜éƒ¨åˆ†æˆ–æŸ¥é˜…å¾®ä¿¡å®˜æ–¹æ–‡æ¡£ã€‚